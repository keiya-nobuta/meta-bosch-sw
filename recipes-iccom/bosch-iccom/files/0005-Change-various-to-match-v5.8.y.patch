From 2bf642b763ebd2bf4bf444e25435d1fe02722a5e Mon Sep 17 00:00:00 2001
From: Keiya Nobuta <h109084@gmail.com>
Date: Sun, 22 Aug 2021 22:41:12 +0900
Subject: [PATCH 5/5] Change various to match v5.8.y

Signed-off-by: Keiya Nobuta <h109084@gmail.com>
---
 src/iccom.c           | 5 ++---
 src/iccom_socket_if.c | 6 +++---
 2 files changed, 5 insertions(+), 6 deletions(-)

diff --git a/src/iccom.c b/src/iccom.c
index 1e1e2a3..96f9996 100644
--- a/src/iccom.c
+++ b/src/iccom.c
@@ -831,7 +831,7 @@ struct iccom_dev_private {
 
 	struct proc_dir_entry *proc_root;
 
-	struct file_operations statistics_ops;
+	struct proc_ops statistics_ops;
 	struct proc_dir_entry *statistics_file;
 };
 
@@ -3965,8 +3965,7 @@ static inline int __iccom_statistics_init(struct iccom_dev *iccom)
 
 	// statistics access operations
 	memset(&iccom->p->statistics_ops, 0, sizeof(iccom->p->statistics_ops));
-	iccom->p->statistics_ops.read  = &__iccom_statistics_read;
-	iccom->p->statistics_ops.owner = THIS_MODULE;
+	iccom->p->statistics_ops.proc_read  = &__iccom_statistics_read;
 
 	if (IS_ERR_OR_NULL(iccom->p->proc_root)) {
 		iccom_err("failed to create statistics proc entry:"
diff --git a/src/iccom_socket_if.c b/src/iccom_socket_if.c
index 6176ddb..2fa0282 100644
--- a/src/iccom_socket_if.c
+++ b/src/iccom_socket_if.c
@@ -213,7 +213,7 @@ struct iccom_sockets_device {
 
         struct proc_dir_entry *proc_root;
 
-        struct file_operations loopback_ctl_ops;
+        struct proc_ops loopback_ctl_ops;
         struct proc_dir_entry *loopback_ctl_file;
 
         struct iccom_sk_loopback_mapping_rule *lback_map_rule;
@@ -817,8 +817,8 @@ static int __iccom_sk_loopback_ctl_init(
         memset(iccom_sk->lback_map_rule, 0, sizeof(*iccom_sk->lback_map_rule));
 
         // loopback control ops
-        iccom_sk->loopback_ctl_ops.read = &__iccom_sk_lback_rule_read;
-        iccom_sk->loopback_ctl_ops.write = &__iccom_sk_lback_rule_write;
+        iccom_sk->loopback_ctl_ops.proc_read = &__iccom_sk_lback_rule_read;
+        iccom_sk->loopback_ctl_ops.proc_write = &__iccom_sk_lback_rule_write;
 
         if (IS_ERR_OR_NULL(iccom_sk->proc_root)) {
                 iccom_socket_err("failed to create loopback control proc entry:"
-- 
2.25.1

